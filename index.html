<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linz Spielt - Spieleausleihe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; } /* gray-800 */
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; } /* gray-600 */
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; } /* gray-500 */
        select {
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%239CA3AF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.4-5.4-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 0.65em auto;
        }
        /* Modal Transition Styles */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 200ms ease-out, transform 200ms ease-out; }
        .modal-leave-active { opacity: 0; transform: scale(0.95); transition: opacity 150ms ease-in, transform 150ms ease-in; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 p-4 sm:p-6 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl sm:text-5xl font-bold text-white">Linz Spielt</h1>
            <p class="text-lg text-blue-400">Spieleausleihe</p>
        </header>

        <!-- Statistik Sektion -->
        <div id="stats-section" class="mb-8 text-center p-4 bg-gray-800/50 rounded-lg border border-gray-700">
            <div id="total-games" class="text-2xl text-white mb-4">Lade Daten...</div>
            <div id="category-stats" class="flex flex-wrap justify-center gap-x-4 gap-y-2 text-gray-400"></div>
        </div>

        <!-- Filterleiste -->
        <div class="bg-gray-800 p-4 rounded-lg mb-8 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4 sticky top-4 z-10 shadow-lg border border-gray-700">
            <div class="md:col-span-2 lg:col-span-2">
                <input type="text" id="search-input" placeholder="Spiel suchen..." class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <select id="category-filter" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500 appearance-none">
                    <option value="all">Alle Kategorien</option>
                </select>
            </div>
             <div>
                <select id="shelf-filter" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500 appearance-none">
                    <option value="0">Alle Regale</option>
                </select>
            </div>
            <div>
                <select id="players-filter" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500 appearance-none">
                    <option value="0">Jede Spielerzahl</option>
                    <option value="1">1 Spieler</option>
                    <option value="2">2 Spieler</option>
                    <option value="3">3 Spieler</option>
                    <option value="4">4 Spieler</option>
                    <option value="5">5 Spieler</option>
                    <option value="6">6 Spieler</option>
                    <option value="7">7+ Spieler</option>
                </select>
            </div>
            <div>
                <select id="duration-filter" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500 appearance-none">
                    <option value="0">Alle Spielzeiten</option>
                    <option value="30">max. 30 Min.</option>
                    <option value="60">max. 60 Min.</option>
                    <option value="90">max. 90 Min.</option>
                    <option value="120">max. 120 Min.</option>
                </select>
            </div>
            <div>
                <select id="status-filter" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500 appearance-none">
                    <option value="all">Alle Status</option>
                    <option value="available">Nur Verfügbare</option>
                    <option value="lent">Nur Ausgeliehene</option>
                </select>
            </div>
        </div>

        <!-- Spieletabelle -->
        <div class="overflow-x-auto bg-gray-800 rounded-lg shadow-lg border border-gray-700">
            <table class="w-full min-w-max">
                <thead class="bg-gray-700/50">
                    <tr>
                        <th class="p-4 text-left text-sm font-semibold text-gray-300 uppercase tracking-wider">Spielname</th>
                        <th class="p-4 text-left text-sm font-semibold text-gray-300 uppercase tracking-wider hidden md:table-cell">Kategorie</th>
                        <th class="p-4 text-center text-sm font-semibold text-gray-300 uppercase tracking-wider hidden sm:table-cell">Regal</th>
                        <th class="p-4 text-center text-sm font-semibold text-gray-300 uppercase tracking-wider hidden lg:table-cell">Spieler</th>
                        <th class="p-4 text-center text-sm font-semibold text-gray-300 uppercase tracking-wider hidden xl:table-cell">Dauer</th>
                        <th class="p-4 text-center text-sm font-semibold text-gray-300 uppercase tracking-wider">Status</th>
                        <th class="p-4 text-center text-sm font-semibold text-gray-300 uppercase tracking-wider">Aktion</th>
                    </tr>
                </thead>
                <tbody id="game-table-body" class="divide-y divide-gray-700">
                    <!-- Spiel-Einträge werden hier per JavaScript eingefügt -->
                </tbody>
            </table>
            <div id="no-results" class="hidden text-center p-8 text-gray-400">
                <p class="text-xl">Keine Spiele gefunden.</p>
            </div>
        </div>
    </div>

    <!-- Modal für Spieldetails -->
    <div id="game-modal-overlay" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div id="game-modal-content" class="bg-gray-800 border border-gray-700 rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] flex flex-col">
            <div class="p-5 border-b border-gray-700">
                <h2 id="modal-title" class="text-2xl font-bold text-white"></h2>
            </div>
            <div id="modal-description" class="p-6 text-gray-300 space-y-4 overflow-y-auto">
                <!-- Beschreibung wird hier eingefügt -->
            </div>
            <div class="p-4 bg-gray-800/50 border-t border-gray-700 text-right">
                <button id="modal-close-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-colors">Schließen</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDocs, writeBatch, onSnapshot, updateDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DATENBANK (LOKALE QUELLE ZUM INITIALISIEREN) ---
        const rawGamesData = [
            { name: '7 Wonders', category: 'Strategiespiel', age: '10+', minAge: 10, players: '2-7', minPlayers: 2, maxPlayers: 7, duration: '30 Min.', minDuration: 30, maxDuration: 30, description: '<h3>Ziel des Spiels:</h3><p>Führe eine antike Zivilisation an und errichte das mächtigste Weltwunder...</p><h3>Spielablauf:</h3><p>Das Spiel geht über drei Zeitalter. In jedem Zeitalter erhalten die Spieler einen Stapel Karten...</p>' },
            { name: '7 Wonders Architects', category: 'Familienspiel', age: '8+', minAge: 8, players: '2-7', minPlayers: 2, maxPlayers: 7, duration: '25 Min.', minDuration: 25, maxDuration: 25, description: '<h3>Ziel des Spiels:</h3><p>Werde zum größten Architekten der Antike...</p><h3>Spielablauf:</h3><p>Eine vereinfachte und schnellere Version von 7 Wonders...</p>' },
            { name: 'Andor Junior', category: 'Kooperatives Spiel', age: '7+', minAge: 7, players: '2-4', minPlayers: 2, maxPlayers: 4, duration: '30-45 Min.', minDuration: 30, maxDuration: 45, description: '<h3>Ziel des Spiels:</h3><p>Als junge Helden müsst ihr gemeinsam die verlorenen Wolfsjungen finden...</p><h3>Spielablauf:</h3><p>Eine vereinfachte, kindgerechte Version des großen Bruders...</p>' },
            { name: 'Arche Nova', category: 'Strategiespiel', age: '14+', minAge: 14, players: '1-4', minPlayers: 1, maxPlayers: 4, duration: '90-150 Min.', minDuration: 90, maxDuration: 150, description: '<h3>Ziel des Spiels:</h3><p>Plane und baue einen modernen, wissenschaftlich geführten Zoo...</p><h3>Spielablauf:</h3><p>Ein komplexes Expertenspiel, bei dem man über einen Aktionskarten-Mechanismus seinen Zoo verwaltet...</p>' },
            { name: 'Azul', category: 'Familienspiel', age: '8+', minAge: 8, players: '2-4', minPlayers: 2, maxPlayers: 4, duration: '30-45 Min.', minDuration: 30, maxDuration: 45, description: '<h3>Ziel des Spiels:</h3><p>Schmücke als Fliesenleger die Wände des königlichen Palastes von Evora...</p><h3>Spielablauf:</h3><p>Spieler wählen reihum Fliesen aus Manufakturen und legen sie auf ihrem Spielertableau ab...</p>' },
            { name: 'Carcassonne', category: 'Familienspiel', age: '7+', minAge: 7, players: '2-5', minPlayers: 2, maxPlayers: 5, duration: '35 Min.', minDuration: 35, maxDuration: 35, description: '<h3>Ziel des Spiels:</h3><p>Erschaffe durch das Legen von Landschaftsplättchen eine mittelalterliche Welt...</p><h3>Spielablauf:</h3><p>Spieler ziehen und legen ein Landschaftsplättchen. Danach können sie einen "Meeple" setzen...</p>' },
            { name: 'Catan', category: 'Strategiespiel', age: '10+', minAge: 10, players: '3-4', minPlayers: 3, maxPlayers: 4, duration: '75 Min.', minDuration: 75, maxDuration: 75, description: '<h3>Ziel des Spiels:</h3><p>Besiedle die Insel Catan. Baue Siedlungen, Städte und Straßen...</p><h3>Spielablauf:</h3><p>Spieler sammeln Rohstoffe (Holz, Lehm, etc.), die durch Würfelwürfe bestimmt werden...</p>' },
            { name: 'CATAN - Das Duell', category: '2-Spieler-Spiel', age: '10+', minAge: 10, players: '2', minPlayers: 2, maxPlayers: 2, duration: '30-75 Min.', minDuration: 30, maxDuration: 75, description: '<h3>Ziel des Spiels:</h3><p>Baue als Fürst oder Fürstin von Catan das mächtigere Fürstentum...</p><h3>Spielablauf:</h3><p>Eine reine Zwei-Spieler-Variante im Catan-Universum...</p>' },
            { name: 'Challengers!', category: 'Party- & Quizspiel', age: '8+', minAge: 8, players: '1-8', minPlayers: 1, maxPlayers: 8, duration: '45 Min.', minDuration: 45, maxDuration: 45, description: '<h3>Ziel des Spiels:</h3><p>Gewinne das größte Capture-the-Flag-Turnier der Welt!...</p><h3>Spielablauf:</h3><p>Ein interaktives Deck-Management-Spiel...</p>' },
            { name: 'Codenames', category: 'Party- & Quizspiel', age: '10+', minAge: 10, players: '2-8+', minPlayers: 2, maxPlayers: 8, duration: '15 Min.', minDuration: 15, maxDuration: 15, description: '<h3>Ziel des Spiels:</h3><p>Zwei Teams treten gegeneinander an. Die jeweiligen Geheimdienstchefs müssen ihre Agenten finden.</p><h3>Spielablauf:</h3><p>Die Geheimdienstchefs geben ihren Teams Hinweise aus nur einem Wort...</p>' },
            { name: 'Die Crew', category: 'Kooperatives Spiel', age: '10+', minAge: 10, players: '2-5', minPlayers: 2, maxPlayers: 5, duration: '20 Min.', minDuration: 20, maxDuration: 20, description: '<h3>Ziel des Spiels:</h3><p>Erfüllt als Astronauten-Crew gemeinsam 50 immer schwieriger werdende Missionen.</p><h3>Spielablauf:</h3><p>Ein kooperatives Stichspiel. In jeder Mission müssen bestimmte Stiche von bestimmten Spielern gewonnen werden...</p>' },
            { name: 'Die weiße Burg', category: 'Strategiespiel', age: '12+', minAge: 12, players: '1-4', minPlayers: 1, maxPlayers: 4, duration: '80 Min.', minDuration: 80, maxDuration: 80, description: '<h3>Ziel des Spiels:</h3><p>Verwalte als Anführer deines Clans Ressourcen, um deine Arbeiter zur Burg Himeji zu schicken...</p><h3>Spielablauf:</h3><p>Ein strategisches Eurogame mit Würfel-Einsetz-Mechanismus...</p>' },
            { name: 'Dixit', category: 'Party- & Quizspiel', age: '8+', minAge: 8, players: '3-8', minPlayers: 3, maxPlayers: 8, duration: '30 Min.', minDuration: 30, maxDuration: 30, description: '<h3>Ziel des Spiels:</h3><p>Sammle die meisten Punkte durch kreative Bildbeschreibungen und cleveres Raten.</p><h3>Spielablauf:</h3><p>Ein Spieler gibt einen Hinweis zu einer seiner surrealen Bildkarten...</p>' },
            { name: 'Dog', category: 'Familienspiel', age: '8+', minAge: 8, players: '4-6', minPlayers: 4, maxPlayers: 6, duration: '30-45 Min.', minDuration: 30, maxDuration: 45, description: '<h3>Ziel des Spiels:</h3><p>Bringe als Team deine vier Murmeln ins Ziel.</p><h3>Spielablauf:</h3><p>Statt Würfeln werden Karten verwendet, um die Figuren zu bewegen...</p>' },
            { name: 'Dominion', category: 'Strategiespiel', age: '13+', minAge: 13, players: '2-4', minPlayers: 2, maxPlayers: 4, duration: '30 Min.', minDuration: 30, maxDuration: 30, description: '<h3>Ziel des Spiels:</h3><p>Baue das mächtigste Königreich, indem du das beste Kartendeck zusammenstellst.</p><h3>Spielablauf:</h3><p>Das Pionierspiel des Deckbau-Genres...</p>' },
            { name: 'Dorf Romantik', category: 'Familienspiel', age: '8+', minAge: 8, players: '1-6', minPlayers: 1, maxPlayers: 6, duration: '30-60 Min.', minDuration: 30, maxDuration: 60, description: '<h3>Ziel des Spiels:</h3><p>Erschafft gemeinsam eine wunderschöne Landschaft aus sechseckigen Plättchen.</p><h3>Spielablauf:</h3><p>Ein kooperatives Legespiel. Spieler decken reihum Plättchen auf und legen sie an...</p>' },
            { name: 'Dune Uprising', category: 'Strategiespiel', age: '14+', minAge: 14, players: '1-6', minPlayers: 1, maxPlayers: 6, duration: '60-120 Min.', minDuration: 60, maxDuration: 120, description: '<h3>Ziel des Spiels:</h3><p>Kämpfe um die Kontrolle über den Wüstenplaneten Arrakis...</p><h3>Spielablauf:</h3><p>Eine Mischung aus Deckbau und Worker-Placement mit neuen Elementen wie Spionen und Sandwürmern.</p>' },
            { name: 'Eine wundervolle Welt', category: 'Strategiespiel', age: '14+', minAge: 14, players: '1-5', minPlayers: 1, maxPlayers: 5, duration: '45 Min.', minDuration: 45, maxDuration: 45, description: '<h3>Ziel des Spiels:</h3><p>Baue das mächtigste Imperium auf, indem du Karten draftest...</p><h3>Spielablauf:</h3><p>Ein Engine-Building-Spiel mit Karten-Drafting...</p>' },
            { name: 'Exploding Kittens', category: 'Kartenspiel', age: '7+', minAge: 7, players: '2-5', minPlayers: 2, maxPlayers: 5, duration: '15 Min.', minDuration: 15, maxDuration: 15, description: '<h3>Ziel des Spiels:</h3><p>Überlebe als Einziger und explodiere nicht!</p><h3>Spielablauf:</h3><p>Eine taktische Version von Russisch Roulette mit Katzen...</p>' },
            { name: 'Fantastische Reiche', category: 'Kartenspiel', age: '10+', minAge: 10, players: '2-6', minPlayers: 2, maxPlayers: 6, duration: '20 Min.', minDuration: 20, maxDuration: 20, description: '<h3>Ziel des Spiels:</h3><p>Stelle die mächtigste Hand aus sieben Karten zusammen...</p><h3>Spielablauf:</h3><p>Ein schnelles Kombinationsspiel. In deinem Zug ziehst du eine Karte und wirfst eine andere ab...</p>' },
            { name: 'Flügelschlag', category: 'Strategiespiel', age: '10+', minAge: 10, players: '1-5', minPlayers: 1, maxPlayers: 5, duration: '40-70 Min.', minDuration: 40, maxDuration: 70, description: '<h3>Ziel des Spiels:</h3><p>Locke als Vogelkundler die schönsten Vögel in dein Naturschutzgebiet...</p><h3>Spielablauf:</h3><p>Spieler führen Aktionen aus, um Futter zu sammeln, Eier zu legen oder neue Vogelkarten zu ziehen...</p>' },
            { name: 'Halli Galli', category: 'Geschicklichkeitsspiel', age: '6+', minAge: 6, players: '2-6', minPlayers: 2, maxPlayers: 6, duration: '15 Min.', minDuration: 15, maxDuration: 15, description: '<h3>Ziel des Spiels:</h3><p>Gewinne alle Karten, indem du als Erster klingelst, wenn genau fünf gleiche Früchte auf dem Tisch liegen.</p><h3>Spielablauf:</h3><p>Alle Spieler decken reihum eine Karte von ihrem Stapel auf...</p>' },
            { name: 'Heat: Pedal to the Metal', category: 'Strategiespiel', age: '10+', minAge: 10, players: '1-6', minPlayers: 1, maxPlayers: 6, duration: '60 Min.', minDuration: 60, maxDuration: 60, description: '<h3>Ziel des Spiels:</h3><p>Gewinne das Autorennen, indem du als Erster die Ziellinie überquerst.</p><h3>Spielablauf:</h3><p>Ein taktisches Rennspiel mit Hand-Management...</p>' },
            { name: 'Just One', category: 'Kooperatives Spiel', age: '8+', minAge: 8, players: '3-7', minPlayers: 3, maxPlayers: 7, duration: '20 Min.', minDuration: 20, maxDuration: 20, description: '<h3>Ziel des Spiels:</h3><p>Erratet als Team so viele geheime Wörter wie möglich.</p><h3>Spielablauf:</h3><p>Ein Spieler ist der Rater und kennt das geheime Wort nicht. Alle anderen schreiben geheim einen Hinweis...</p>' },
            { name: 'Karak', category: 'Familienspiel', age: '7+', minAge: 7, players: '2-5', minPlayers: 2, maxPlayers: 5, duration: '45 Min.', minDuration: 45, maxDuration: 45, description: '<h3>Ziel des Spiels:</h3><p>Erkunde als einer von sechs Helden die Katakomben der Burg Karak...</p><h3>Spielablauf:</h3><p>Ein einfacher Dungeon-Crawler. Spieler decken neue Gänge auf, kämpfen per Würfelwurf...</p>' },
            { name: 'Knarr', category: 'Familienspiel', age: '10+', minAge: 10, players: '2-4', minPlayers: 2, maxPlayers: 4, duration: '30 Min.', minDuration: 30, maxDuration: 30, description: '<h3>Ziel des Spiels:</h3><p>Heuere als Wikinger-Anführer die beste Crew an, entdecke neue Länder...</p><h3>Spielablauf:</h3><p>Ein Set-Collection- und Engine-Building-Spiel...</p>' },
            { name: 'Mischwald', category: 'Strategiespiel', age: '10+', minAge: 10, players: '2-5', minPlayers: 2, maxPlayers: 5, duration: '40-60 Min.', minDuration: 40, maxDuration: 60, description: '<h3>Ziel des Spiels:</h3><p>Erschaffe einen ökologisch ausgewogenen Wald...</p><h3>Spielablauf:</h3><p>Ein Kartenspiel, bei dem die Spieler Bäume in ihre Auslage pflanzen...</p>' },
            { name: 'PARKS', category: 'Familienspiel', age: '10+', minAge: 10, players: '1-5', minPlayers: 1, maxPlayers: 5, duration: '30-60 Min.', minDuration: 30, maxDuration: 60, description: '<h3>Ziel des Spiels:</h3><p>Sammle als Wanderer über vier Jahreszeiten hinweg die meisten Siegpunkte...</p><h3>Spielablauf:</h3><p>Spieler bewegen ihre beiden Wanderer über einen Pfad, der in jeder Runde neu und länger wird...</p>' },
            { name: 'Sky Team', category: '2-Spieler-Spiel', age: '12+', minAge: 12, players: '2', minPlayers: 2, maxPlayers: 2, duration: '20 Min.', minDuration: 20, maxDuration: 20, description: '<h3>Ziel des Spiels:</h3><p>Landet als Team aus Pilot und Co-Pilot ein Flugzeug sicher...</p><h3>Spielablauf:</h3><p>Ein kooperatives Würfel-Platzierungsspiel nur für zwei Personen...</p>' },
            { name: 'Zug um Zug', category: 'Familienspiel', age: '8+', minAge: 8, players: '2-5', minPlayers: 2, maxPlayers: 5, duration: '30-60 Min.', minDuration: 30, maxDuration: 60, description: '<h3>Ziel des Spiels:</h3><p>Baue ein Eisenbahnnetz quer durch die USA...</p><h3>Spielablauf:</h3><p>Erfülle geheime Zielkarten, die dir vorgeben, welche Städte du verbinden musst...</p>' }
        ];

        // Globale Variable für Spieldaten
        let gamesData = []; 

        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('search-input');
            const categoryFilter = document.getElementById('category-filter');
            const playersFilter = document.getElementById('players-filter');
            const durationFilter = document.getElementById('duration-filter');
            const shelfFilter = document.getElementById('shelf-filter');
            const statusFilter = document.getElementById('status-filter');
            const tableBody = document.getElementById('game-table-body');
            const noResultsDiv = document.getElementById('no-results');

            // Modal Elemente
            const modalOverlay = document.getElementById('game-modal-overlay');
            const modalContent = document.getElementById('game-modal-content');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            
            // --- Cookie-Funktionen ---
            const saveStateToCookie = () => {
                const lentGameIds = gamesData.filter(game => game.isLent).map(game => game.id);
                const expires = new Date(Date.now() + 2 * 864e5).toUTCString();
                document.cookie = `lentGamesLinz=${JSON.stringify(lentGameIds)}; expires=${expires}; path=/; SameSite=Lax`;
            };
            const loadStateFromCookie = () => {
                const cookieString = document.cookie.split('; ').find(row => row.startsWith('lentGamesLinz='));
                if (cookieString) {
                    try {
                        const lentGameIds = JSON.parse(cookieString.split('=')[1]);
                        if (Array.isArray(lentGameIds)) {
                            gamesData.forEach(game => {
                                game.isLent = lentGameIds.includes(game.id);
                            });
                        }
                    } catch (e) { console.error("Cookie-Fehler:", e); }
                }
            };

            const initializeLocalData = () => {
                 gamesData = rawGamesData.map((game, index) => ({
                    id: index + 1,
                    title: game.name,
                    shelf: Math.floor(Math.random() * 20) + 1,
                    categories: Array.isArray(game.category) ? game.category : [game.category],
                    playerCount: game.players,
                    minPlayers: game.minPlayers,
                    maxPlayers: game.maxPlayers,
                    duration: game.duration,
                    maxDuration: game.maxDuration,
                    age: game.age,
                    description: game.description || 'Keine Beschreibung verfügbar.',
                    isLent: false
                }));
                gamesData.sort((a, b) => a.title.localeCompare(b.title));
                loadStateFromCookie();
            };

            const renderStats = () => {
                const totalGamesDiv = document.getElementById('total-games');
                const categoryStatsDiv = document.getElementById('category-stats');

                totalGamesDiv.innerHTML = `Gesamtanzahl der Spiele: <span class="font-bold text-blue-400">${gamesData.length}</span>`;

                const categoryCounts = gamesData.flatMap(game => game.categories).reduce((acc, category) => {
                    acc[category] = (acc[category] || 0) + 1;
                    return acc;
                }, {});

                let statsHTML = '';
                Object.keys(categoryCounts).sort().forEach(category => {
                    statsHTML += `<span class="bg-gray-700 px-3 py-1 rounded-full text-sm whitespace-nowrap">${category}: ${categoryCounts[category]}</span>`;
                });
                categoryStatsDiv.innerHTML = statsHTML;
            };

            const populateCategories = () => {
                const categories = [...new Set(gamesData.flatMap(game => game.categories))];
                categories.sort();
                categoryFilter.innerHTML = '<option value="all">Alle Kategorien</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categoryFilter.appendChild(option);
                });
            };
            
            const populateShelves = () => {
                for (let i = 1; i <= 20; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `Regal ${i}`;
                    shelfFilter.appendChild(option);
                }
            };

            const renderTable = (filteredGames) => {
                tableBody.innerHTML = '';
                noResultsDiv.classList.toggle('hidden', filteredGames.length > 0);

                filteredGames.forEach(game => {
                    const row = document.createElement('tr');
                    row.className = `transition-colors duration-200 ${game.isLent ? 'opacity-50' : 'hover:bg-gray-700/50'}`;
                    row.dataset.gameId = game.id;

                    const lentStatusText = game.isLent ? 'Ausgeliehen' : 'Verfügbar';
                    const lentStatusClasses = game.isLent ? 'text-red-400' : 'text-green-400';
                    const buttonText = game.isLent ? 'Zurückgeben' : 'Ausleihen';
                    const buttonClasses = game.isLent ? 'bg-yellow-600 hover:bg-yellow-500' : 'bg-blue-600 hover:bg-blue-500';

                    row.innerHTML = `
                        <td class="p-4 font-medium text-white cursor-pointer hover:text-blue-400 game-title-cell">${game.title}</td>
                        <td class="p-4 text-left text-gray-300 hidden md:table-cell">${game.categories.join(', ')}</td>
                        <td class="p-4 text-center text-gray-300 hidden sm:table-cell font-semibold text-lg">${game.shelf}</td>
                        <td class="p-4 text-center text-gray-300 hidden lg:table-cell">${game.playerCount}</td>
                        <td class="p-4 text-center text-gray-300 hidden xl:table-cell">${game.duration}</td>
                        <td class="p-4 text-center font-semibold ${lentStatusClasses}">${lentStatusText}</td>
                        <td class="p-4 text-center">
                            <button class="status-button w-full sm:w-auto text-white font-semibold py-2 px-4 rounded-md transition-colors text-sm ${buttonClasses}">
                                ${buttonText}
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            };
            
            const showModal = (game) => {
                document.getElementById('modal-title').textContent = game.title;
                document.getElementById('modal-description').innerHTML = game.description;
                
                modalOverlay.classList.remove('hidden');
                modalContent.classList.remove('modal-leave-active');
                modalContent.classList.add('modal-enter-active');
            };

            const hideModal = () => {
                modalContent.classList.remove('modal-enter-active');
                modalContent.classList.add('modal-leave-active');
                setTimeout(() => {
                    modalOverlay.classList.add('hidden');
                }, 150);
            };

            const toggleLentStatus = (gameId) => {
                const game = gamesData.find(g => g.id === gameId);
                if (game) {
                    game.isLent = !game.isLent;
                    saveStateToCookie();
                    filterAndRender();
                }
            };

            const filterAndRender = () => {
                if (!gamesData.length) return; 

                const searchTerm = searchInput.value.toLowerCase();
                const selectedCategory = categoryFilter.value;
                const selectedPlayers = parseInt(playersFilter.value, 10);
                const selectedDuration = parseInt(durationFilter.value, 10);
                const selectedShelf = parseInt(shelfFilter.value, 10);
                const selectedStatus = statusFilter.value;

                const filteredGames = gamesData.filter(game => {
                    const nameMatch = game.title.toLowerCase().includes(searchTerm);
                    const categoryMatch = selectedCategory === 'all' || game.categories.includes(selectedCategory);
                    const shelfMatch = selectedShelf === 0 || game.shelf === selectedShelf;
                    
                    let playersMatch = true;
                    if (selectedPlayers > 0) {
                        if (selectedPlayers < 7) {
                            playersMatch = game.minPlayers <= selectedPlayers && game.maxPlayers >= selectedPlayers;
                        } else {
                            playersMatch = game.maxPlayers >= 7;
                        }
                    }
                    
                    const durationMatch = selectedDuration === 0 || game.maxDuration <= selectedDuration;
                    
                    const statusMatch = selectedStatus === 'all' ||
                                        (selectedStatus === 'lent' && game.isLent) ||
                                        (selectedStatus === 'available' && !game.isLent);

                    return nameMatch && categoryMatch && playersMatch && durationMatch && shelfMatch && statusMatch;
                });
                renderTable(filteredGames);
            };

            // Event Listeners
            [searchInput, categoryFilter, playersFilter, durationFilter, shelfFilter, statusFilter].forEach(el => {
                el.addEventListener('input', filterAndRender);
                el.addEventListener('change', filterAndRender);
            });

            tableBody.addEventListener('click', (event) => {
                const target = event.target;
                if (target.classList.contains('status-button')) {
                    const gameRow = target.closest('tr');
                    const gameId = parseInt(gameRow.dataset.gameId, 10);
                    toggleLentStatus(gameId);
                } else if (target.closest('.game-title-cell')) {
                    const gameRow = target.closest('tr');
                    const gameId = parseInt(gameRow.dataset.gameId, 10);
                    const game = gamesData.find(g => g.id === gameId);
                    if (game) showModal(game);
                }
            });
            
            modalCloseBtn.addEventListener('click', hideModal);
            modalOverlay.addEventListener('click', (event) => {
                if (event.target === modalOverlay) {
                    hideModal();
                }
            });

            // Initialisierung
            initializeLocalData();
            populateCategories();
            populateShelves();
            renderStats();
            filterAndRender();
        });
    </script>
</body>
</html>
